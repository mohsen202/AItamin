const startQuizButton = document.getElementById('start-quiz-button');

let quizQuestions = [];
let currentQuestionIndex = 0;
let userScore = 0;

// بارگیری سوالات از Google Sheets
async function loadQuestions() {
    try {
        const sheetId = '15B8xmtlFeP1vlT-_0ZhHO3EAzo19l0Gg9ZFIALuHdwk'; // شناسه فایل Google Sheets
        const gid = '109137920'; // شناسه صفحه (Sheet)
        const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${gid}`;

        const response = await fetch(url);
        const text = await response.text();
        const json = JSON.parse(text.substring(47, text.length - 2)); // پردازش پاسخ JSON

        quizQuestions = json.table.rows.map(row => {
            const question = row.c[0].v; // ستون اول: سوال
            const options = row.c.slice(1, 5).map(cell => cell.v); // ستون‌های ۲ تا ۵: گزینه‌ها
            const correctAnswer = row.c[5].v; // ستون ششم: پاسخ صحیح
            return { question, options, correctAnswer };
        });

        console.log("سوالات بارگیری شدند:", quizQuestions); // برای دیباگ
    } catch (error) {
        console.error("خطا در بارگیری سوالات:", error);
    }
}

// شروع آزمون
function startQuiz() {
    if (quizQuestions.length === 0) {
        console.error("سوالات بارگیری نشده‌اند!"); // برای دیباگ
        addMessage("خطا: سوالات بارگیری نشده‌اند.", 'bot');
        return;
    }
    currentQuestionIndex = 0;
    userScore = 0;
    chatContainer.innerHTML = ''; // پاک کردن چت قبلی
    showQuestion(quizQuestions[currentQuestionIndex]);
}

// نمایش سوال
function showQuestion(questionData) {
    console.log("نمایش سوال:", questionData); // برای دیباگ
    addMessage(questionData.question, 'bot');
    const optionsDiv = document.createElement('div');
    optionsDiv.classList.add('options');
    questionData.options.forEach((option, index) => {
        const button = document.createElement('button');
        button.textContent = option;
        button.addEventListener('click', () => handleAnswer(index, questionData));
        optionsDiv.appendChild(button);
    });
    chatContainer.appendChild(optionsDiv);
}

// رویداد کلیک دکمه شروع آزمون
startQuizButton.addEventListener('click', () => {
    console.log("دکمه شروع آزمون کلیک شد!"); // برای دیباگ
    startQuiz();
});

// بارگیری سوالات هنگام لود صفحه
loadQuestions();
